
{% extends "base.html" %}
{% block content %}

<div class="card">
  <h1>Add New Entry</h1>

  <div class="form-row">
    <div class="col">
      <label>Mode</label>
      <select id="form_type">
        <option value="income">Income</option>
        <option value="expense">Expense</option>
      </select>
    </div>
  </div>

  <form method="post" id="entryForm">
    <input type="hidden" name="form_type" id="form_type_hidden" value="income">

    <div class="grid-3" style="margin-top:10px;">
      <div>
        <label>Date</label>
        <div style="display:flex; gap:8px; align-items:center;">
          <input type="date" name="entry_date" id="entry_date" required onclick="if(this.showPicker){this.showPicker()}" onfocus="if(this.showPicker){this.showPicker()}">
          <button type="button" class="btn secondary" onclick="if(document.getElementById('entry_date').showPicker){document.getElementById('entry_date').showPicker()}">ðŸ“…</button>
        </div>
      </div>
      <div>
        <label>Truck</label>
        <select name="truck_id" required>
          <option value="">â€”</option>
          {% for t in trucks %}<option value="{{ t.id }}">{{ t.name }}</option>{% endfor %}
        </select>
      </div>
      <div>
        <label>Driver</label>
        <select name="driver_id" required>
          <option value="">â€”</option>
          {% for d in drivers %}<option value="{{ d.id }}">{{ d.name }}</option>{% endfor %}
        </select>
      </div>
    </div>

    <!-- Income section -->
    <div id="incomeFields" class="grid-3" style="margin-top:10px;">
      <div>
        <label>Income Amount ($)</label>
        <input type="number" step="0.01" name="income_amount" id="income_amount">
      </div>
    </div>

    <!-- Expense section -->
    <div id="expenseFields" class="grid-3" style="margin-top:10px; display:none;">
      <div>
        <label>Expense Type</label>
        <select name="category" id="expense_category">
          <option>Fuel</option>
          <option>Driver Pay</option>
          <option>Insurance</option>
          <option>Parking</option>
          <option>Other</option>
        </select>
      </div>
      <div>
        <label>Expense Amount ($)</label>
        <input type="number" step="0.01" name="expense_amount" id="expense_amount">
      </div>
      <div>
        <label>HST</label>
        <select name="hst_option" id="hst_option">
          <option value="with">Amount includes HST</option>
          <option value="without">Amount is without HST (add 13%)</option>
        </select>
      </div>
    </div>

    <!-- Shared description -->
    <div class="grid-3" style="margin-top:10px;">
      <div class="col" style="grid-column: span 3;">
        <label>Description</label>
        <input type="text" name="description" placeholder="e.g., Petro-Pass Mississauga" required>
      </div>
    </div>

    <div style="margin-top:10px;"><button class="btn">Save Entry</button></div>
  </form>
</div>

<script>
  const formType = document.getElementById('form_type');
  const hiddenType = document.getElementById('form_type_hidden');
  const incomeFields = document.getElementById('incomeFields');
  const expenseFields = document.getElementById('expenseFields');
  const incomeAmount = document.getElementById('income_amount');
  const expenseAmount = document.getElementById('expense_amount');

  function syncForm(){
    if (formType.value === 'income') {
      incomeFields.style.display = 'grid';
      expenseFields.style.display = 'none';
      if (incomeAmount) incomeAmount.required = true;
      if (expenseAmount) expenseAmount.required = false;
    } else {
      incomeFields.style.display = 'none';
      expenseFields.style.display = 'grid';
      if (incomeAmount) incomeAmount.required = false;
      if (expenseAmount) expenseAmount.required = true;
    }
    hiddenType.value = formType.value;
  }
  formType.addEventListener('change', syncForm);
  syncForm();
</script>
<div class="card">
  <h2>Filter by Date</h2>
  <form method="get" class="form-row">
    <div class="col">
      <label>From</label>
      <div style="display:flex; gap:8px; align-items:center;">
        <input type="date" name="from" id="from" onclick="if(this.showPicker){this.showPicker()}" onfocus="if(this.showPicker){this.showPicker()}">
        <button type="button" class="btn secondary" onclick="openDatePicker('from')">ðŸ“…</button>
      </div>
    </div>
    <div class="col">
      <label>To</label>
      <div style="display:flex; gap:8px; align-items:center;">
        <input type="date" name="to" id="to" onclick="if(this.showPicker){this.showPicker()}" onfocus="if(this.showPicker){this.showPicker()}">
        <button type="button" class="btn secondary" onclick="openDatePicker('to')">ðŸ“…</button>
      </div>
    </div>
    <button class="btn">Apply</button>
  </form>
</div>

<div class="card">
  <h2>Entries (latest 200)</h2>
  <table class="table">
    <thead><tr><th>Date</th><th>Type</th><th>Category</th><th>Truck</th><th>Driver</th><th>Description</th><th style="text-align:right;">Amount</th><th>Actions</th></tr></thead>
    <tbody>
      {% if entries|length == 0 %}<tr><td colspan="8">No data available.</td></tr>{% endif %}
      {% for e in entries %}
      <tr>
        <td>{{ e.entry_date }}</td>
        <td>{{ 'Income' if e.is_income==1 else 'Expense' }}</td>
        <td>{{ e.category }}</td>
        <td>{{ e.truck_name or '-' }}</td>
        <td>{{ e.driver_name or '-' }}</td>
        <td>{{ e.description or '' }}</td>
        <td style="text-align:right;">
          {% if e.is_income==1 %}{{ e.amount|currency }}
          {% else %}{% if e.hst_included==1 %}{{ e.amount|currency }}{% else %}{{ (e.amount*1.13)|round(2)|currency }}{% endif %}{% endif %}
        </td>
        <td>
          <div class="actions">
            <a class="btn secondary" href="{{ url_for('edit_entry', id=e.id) }}">Edit</a>
            <form method="post" action="{{ url_for('delete_entry', id=e.id) }}" onsubmit="return askDeletePassword(this, 'Delete this entry?')">
              <button class="btn danger">Delete</button>
            </form>
          </div>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<script>
  const formType = document.getElementById('form_type');
  const hiddenType = document.getElementById('form_type_hidden');
  const incomeFields = document.getElementById('incomeFields');
  const expenseFields = document.getElementById('expenseFields');
  function syncForm(){
    const expAmount = document.querySelector('#expenseFields input[name="expense_amount"]');
    const incAmount = document.querySelector('#incomeFields input[name="income_amount"]');
    if (formType.value === 'income') { if(incAmount){incAmount.required=true;} if(expAmount){expAmount.required=false;} }
    else { if(incAmount){incAmount.required=false;} if(expAmount){expAmount.required=true;} }
    hiddenType.value = formType.value;
    incomeFields.style.display = formType.value === 'income' ? 'grid' : 'none';
    expenseFields.style.display = formType.value === 'expense' ? 'grid' : 'none';
  }
  formType.addEventListener('change', syncForm);
  syncForm();
</script>
{% endblock %}
